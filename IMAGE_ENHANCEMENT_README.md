# 图像预处理工具使用说明

本工具用于对 YOLOv8 RTA 数据集进行亮度和对比度均衡处理，生成增强后的新数据集。

## 功能特点

### 支持的增强方法
1. **CLAHE (推荐)** - 对比度限制自适应直方图均衡化
   - 最佳的亮度和对比度平衡
   - 避免过度增强
   - 适合大多数场景

2. **直方图均衡化** - 传统的全局直方图均衡
   - 增强整体对比度
   - 可能导致某些区域过度增强

3. **伽马校正** - 调整图像亮度曲线
   - 适合亮度偏暗的图像
   - 保持颜色平衡

4. **自适应亮度** - 根据图像平均亮度调整
   - 自动调整到目标亮度
   - 适合亮度不均匀的图像

5. **组合增强** - CLAHE + 轻微伽马校正
   - 综合多种方法的优点
   - 效果更加自然

## 使用方法

### 1. 预览增强效果（推荐先执行）

```bash
python preview_enhancement.py
```

这会：
- 从训练集中选择3张样本图像
- 应用所有增强方法
- 生成对比图保存到 `./image_enhancement_preview/` 目录
- 显示亮度分布对比

### 2. 快速处理数据集

```bash
python enhance_dataset.py
```

这会：
- 使用 CLAHE 方法处理整个数据集
- 生成新数据集到 `./datasets/yolo_RTA_enhanced/` 目录
- 保持原始文件名不变
- 复制标签文件和配置文件

### 3. 自定义处理

```bash
python image_preprocess.py --source ./datasets/yolo_RTA --target ./datasets/yolo_RTA_custom --method combined
```

参数说明：
- `--source`: 源数据集路径
- `--target`: 目标数据集路径
- `--method`: 增强方法 (clahe/histogram_eq/gamma_correction/adaptive_brightness/combined)
- `--preview`: 仅预览效果，不处理整个数据集

### 4. 预览单张图像

```bash
python image_preprocess.py --preview --source ./datasets/yolo_RTA
```

## 输出结构

处理后的数据集结构：
```
datasets/yolo_RTA_enhanced/
├── images/
│   ├── train/          # 增强后的训练图像
│   ├── val/            # 增强后的验证图像
│   └── test/           # 增强后的测试图像
├── labels/
│   ├── train/          # 复制的标签文件
│   ├── val/
│   └── test/
├── data.yaml           # 复制的配置文件
├── yolo_RTA.yaml       # 复制的配置文件
└── enhanced_clahe.yaml # 新的增强配置文件
```

## 文件说明

- `image_preprocess.py` - 主要的图像预处理脚本
- `enhance_dataset.py` - 快速处理脚本
- `preview_enhancement.py` - 预览效果脚本

## 技术细节

### CLAHE (对比度限制自适应直方图均衡化)
- **工作原理**: 将图像分成小块，对每块单独进行直方图均衡，然后通过双线性插值合并
- **参数**: 
  - `clipLimit=2.0`: 限制对比度增强程度，避免噪声放大
  - `tileGridSize=(8,8)`: 将图像分成8x8的网格
- **优势**: 
  - 保持局部细节
  - 避免过度增强
  - 适合不均匀光照的图像

### 处理流程
1. 读取原始图像
2. 检测图像格式（彩色/灰度）
3. 应用选定的增强方法
4. 保存增强后的图像
5. 复制对应的标签文件

## 建议

1. **首先运行预览**: 使用 `preview_enhancement.py` 查看不同方法的效果
2. **推荐使用 CLAHE**: 大多数情况下效果最佳
3. **保留原数据集**: 增强处理会创建新的数据集，不会覆盖原始数据
4. **检查增强效果**: 确认增强后的图像质量符合要求
5. **训练对比**: 可以用原始数据集和增强数据集分别训练，对比效果

## 常见问题

### Q: 处理需要多长时间？
A: 取决于数据集大小，通常每张图像处理时间约0.1-0.5秒

### Q: 会影响标签吗？
A: 不会，标签文件直接复制，坐标不变

### Q: 可以处理TIF格式吗？
A: 可以，支持常见的图像格式（JPG, PNG, TIF, BMP等）

### Q: 如何选择增强方法？
A: 建议先用预览功能查看效果，通常CLAHE方法效果最佳

### Q: 增强后图像会变大吗？
A: 文件大小可能略有变化，但图像尺寸和质量保持不变

## 注意事项

- 确保有足够的磁盘空间存储新数据集
- 增强后的数据集约为原数据集大小的1倍
- 处理过程中请勿中断，可能导致数据不完整
- 建议在处理大数据集前先用小样本测试
